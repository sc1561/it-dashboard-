<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>خريطة الأعمدة والخلايا لإكسل – HTML/CSS/JS</title>
  <!-- مكتبة قراءة ملفات Excel في المتصفح -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#0f172a;        /* slate-900 */
      --panel:#111827;     /* gray-900 */
      --muted:#94a3b8;     /* slate-400 */
      --text:#e5e7eb;      /* gray-200 */
      --accent:#22c55e;    /* green-500 */
      --accent-2:#10b981;  /* emerald-500 */
      --warn:#f59e0b;      /* amber-500 */
      --danger:#ef4444;    /* red-500 */
      --chip:#1f2937;      /* gray-800 */
      --border:#1f2937;    /* gray-800 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Kufi Arabic", Tahoma, Arial, sans-serif;
      background:linear-gradient(135deg, var(--bg), #0b1024);
      color:var(--text);
    }
    header{
      padding: 24px 20px;
      display:flex;gap:16px;align-items:center;flex-wrap:wrap;
      border-bottom:1px solid var(--border);
      position:sticky;top:0;background:rgba(15,23,42,.8);backdrop-filter: blur(10px);
      z-index:5
    }
    header h1{margin:0;font-weight:700;font-size:22px}
    header .subtitle{color:var(--muted);font-size:14px}
    .container{max-width:1200px;margin:24px auto;padding:0 20px}

    .card{background:linear-gradient(180deg, #0b1229, #0a1222);
      border:1px solid var(--border);border-radius:16px; padding:16px 16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){
      .row{grid-template-columns:1.2fr .8fr}
    }

    .uploader{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    input[type="file"]{background:var(--panel); color:var(--text); border:1px dashed #374151; padding:12px; border-radius:12px}
    .btn{cursor:pointer; background:var(--accent); color:#04210e; border:none; padding:10px 14px; border-radius:12px; font-weight:700}
    .btn.secondary{background:#1f2937; color:var(--text)}
    .btn.ghost{background:transparent; border:1px solid #374151; color:var(--text)}
    .btn.small{padding:8px 10px; font-size:12px; border-radius:10px}

    .options{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    .opt{background:var(--chip);border:1px solid var(--border);padding:8px 10px;border-radius:10px;color:var(--muted);font-size:12px}

    .results{display:flex;flex-direction:column;gap:16px;margin-top:20px}
    .file-card{border:1px solid var(--border);background:#0b1120;border-radius:16px}
    .file-head{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
    .file-title{font-weight:700}
    .file-tools{display:flex;gap:8px;align-items:center}

    .sheet{border-top:1px solid var(--border)}
    .sheet-head{display:flex;align-items:center;gap:10px;padding:12px 14px}
    .badge{background:var(--chip);border:1px solid var(--border);color:var(--muted);padding:4px 8px;border-radius:999px;font-size:12px}
    .muted{color:var(--muted)}

    .sheet-actions{display:flex;gap:8px;flex-wrap:wrap;padding:0 14px 12px 14px}

    .filter{display:flex;gap:8px;align-items:center;margin-right:auto}
    .filter input{background:var(--panel);border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px}

    table{width:100%; border-collapse:collapse; font-size:13px}
    thead th{position:sticky; top:0; background:#0b1229; z-index:2}
    th, td{border-bottom:1px dashed #1f2937; padding:10px; text-align:right}
    tbody tr:hover{background:#0b1a36}
    .key{color:#22c55e; font-weight:700}
    .danger{color:var(--danger)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    details{border-top:1px dashed #1f2937}
    summary{cursor:pointer; list-style:none; padding:8px 14px; color:var(--muted)}
    summary::-webkit-details-marker{display:none}

    .footer{margin:32px 0; color:var(--muted); font-size:12px; text-align:center}
  </style>
</head>
<body>
  <header>
    <h1>خريطة الأعمدة والخلايا لملفات Excel</h1>
    <div class="subtitle">أرفق ملف/ملفات ‎.xlsx‎ وسيتم استخراج عناوين الأعمدة، الصفوف، وعناوين الخلايا بطريقة ديناميكية</div>
  </header>

  <div class="container">
    <div class="card">
      <div class="row">
        <div>
          <div class="uploader">
            <input id="fileInput" type="file" accept=".xlsx,.xls" multiple />
            <button id="analyzeBtn" class="btn">تحليل الملفّات</button>
            <button id="clearBtn" class="btn secondary">تفريغ النتائج</button>
          </div>
          <div class="options">
            <div class="opt">عدد الصفوف المفحوصة للعناوين: <strong id="hdrCountLabel">12</strong></div>
            <input id="hdrCount" type="range" min="3" max="20" value="12" />
            <div class="opt">كلمات الأعمدة المهمة (قابلة للتعديل):
              <input id="keyWords" type="text" style="min-width:280px" value="اسم الطالب,الطالب,الصف,الشعبة,الفصل,المادة,رقم,id" />
            </div>
          </div>
        </div>
        <div>
          <div class="card" style="background:#0a1222">
            <div style="font-weight:700;margin-bottom:6px">كيف يعمل؟</div>
            <ul style="margin:0 0 0 18px;color:var(--muted);line-height:1.7">
              <li>يكتشف صف العناوين تلقائياً (أكثر صف ممتلئ ضمن أول <span class="mono" id="howMany">12</span> صفوف).</li>
              <li>ينشئ ملخصاً لكل عمود: حرف/رقم العمود، خلية عنوان العمود، أول صف بيانات، مثال أول قيمة، وعدّاد القيم غير الفارغة.</li>
              <li>يعلم الأعمدة <span class="key">المهمة</span> إذا احتوت العناوين على الكلمات المحددة.</li>
              <li>يوفّر تنزيل CSV للملخص، وCSV لتفريغ كل الخلايا لكل ورقة.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div id="results" class="results"></div>

    <div class="footer">© خريطة الأعمدة – يعمل محلياً في المتصفح. لا تُرسل ملفاتك للخادم.</div>
  </div>

  <script>
    // ===== أدوات مساعدة =====
    const byId = (id) => document.getElementById(id);

    function colToLetter(n){
      let s = ""; let r = n;
      while(r>0){
        let m = (r-1)%26; s = String.fromCharCode(65+m)+s; r = Math.floor((r-1)/26);
      }
      return s;
    }
    function letterToCol(letters){
      let sum = 0; for(let i=0;i<letters.length;i++){ sum = sum*26 + (letters.charCodeAt(i)-64); } return sum;
    }
    function downloadCSV(filename, rows){
      const process = (v)=> (v==null?"":String(v).replaceAll('"','""'));
      const csv = rows.map(r=> r.map(c=>`"${process(c)}"`).join(",")).join("\n");
      const blob = new Blob(["\ufeff"+csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function createEl(tag, props={}, ...children){
      const el = document.createElement(tag);
      Object.assign(el, props);
      children.forEach(c=>{
        if(c==null) return;
        if (typeof Node !== 'undefined' && c instanceof Node) {
          el.appendChild(c);
        } else if (typeof c === 'object' && c && 'nodeType' in c) {
          el.appendChild(c);
        } else {
          el.appendChild(document.createTextNode(String(c)));
        }
      });
      return el;
    }

    function sheetTo2DArray(sheet){
      // تحويل الورقة إلى مصفوفة صفوف/أعمدة مع الفراغات
      const range = XLSX.utils.decode_range(sheet['!ref']);
      const rows = [];
      for(let r=range.s.r; r<=range.e.r; r++){
        const row=[];
        for(let c=range.s.c; c<=range.e.c; c++){
          const addr = XLSX.utils.encode_cell({r,c});
          const cell = sheet[addr];
          row.push(cell? cell.v: "");
        }
        rows.push(row);
      }
      return {rows, range};
    }

    function detectHeaderRow(rows, maxScan){
      let maxFilled=-1, idx=0;
      const limit = Math.min(maxScan, rows.length);
      for(let r=0; r<limit; r++){
        const filled = rows[r].filter(v=> v!==null && String(v).trim()!=="").length;
        if(filled > maxFilled){ maxFilled = filled; idx = r; }
      }
      return idx; // صفرية (0-based)
    }

    function analyzeSheet(wsTitle, sheet, keyWords, maxScan){
      const {rows, range} = sheetTo2DArray(sheet);
      const headerRow = detectHeaderRow(rows, maxScan);
      const startCol = range.s.c, endCol = range.e.c;
      const firstDataRow = headerRow + 2; // +1 لأن صفرية +1 صف بعد العنوان
      const keywords = keyWords.split(',').map(s=> s.trim()).filter(Boolean);

      const summary = [];
      const cellDump = [];

      // تفريغ كل الخلايا (بالمدى فقط) مع عناوينها
      for(let c=startCol; c<=endCol; c++){
        const colLetter = colToLetter(c - startCol + 1); // العرض 1-based داخل الجدول المبسّط
        const excelColLetter = colToLetter(c+1); // عنوان إكسل الحقيقي (A=1)
        for(let r=range.s.r; r<=range.e.r; r++){
          const value = rows[r][c-startCol];
          cellDump.push([
            wsTitle,
            `${excelColLetter}${r+1}`,
            r+1,
            excelColLetter,
            c+1,
            value
          ]);
        }
      }

      for(let c=startCol; c<=endCol; c++){
        const excelColLetter = colToLetter(c+1);
        const headerVal = rows[headerRow]?.[c-startCol] ?? "";
        // عدّاد غير الفارغ وأول مثال قيمة
        let nonEmpty=0; let exampleAddr=""; let exampleVal="";
        for(let r=headerRow+1; r<rows.length; r++){
          const v = rows[r]?.[c-startCol];
          if(v!==null && String(v).trim()!==''){
            nonEmpty++; if(!exampleAddr){ exampleAddr = `${excelColLetter}${r+1}`; exampleVal = v; }
          }
        }
        if(String(headerVal).trim()==='' && nonEmpty===0){
          continue; // عمود فارغ تماماً
        }
        const isKey = keywords.some(k=> String(headerVal).includes(k));
        summary.push([
          wsTitle,
          excelColLetter,
          c+1,
          `${excelColLetter}${headerRow+1}`,
          String(headerVal||''),
          firstDataRow,
          exampleAddr,
          exampleVal,
          nonEmpty,
          isKey? 'نعم':'لا'
        ]);
      }

      return {headerRow: headerRow+1, firstDataRow, summary, cellDump};
    }

    function renderSheet(container, fileName, wsName, analysis){
      const [HDR_WS, HDR_COL_LETTER, HDR_COL_NUM, HDR_HDR_CELL, HDR_TITLE, HDR_FIRST_DATA,
             HDR_EXAMPLE_CELL, HDR_EXAMPLE_VAL, HDR_NONEMPTY, HDR_IS_KEY] = [0,1,2,3,4,5,6,7,8,9];

      const section = createEl('div', {className:'sheet'});
      const head = createEl('div', {className:'sheet-head'},
        createEl('div', {className:'badge'}, `الورقة: ${wsName}`),
        createEl('div', {className:'muted'}, `صف العناوين: ${analysis.headerRow} · أول صف بيانات: ${analysis.firstDataRow}`)
      );

      const filterBox = createEl('div', {className:'sheet-actions'},
        createEl('div', {className:'filter'},
          createEl('label', {}, 'بحث: '),
          createEl('input', {type:'search', placeholder:'ابحث في العناوين/القيم...', oninput:e=>{
            const q = e.target.value.trim().toLowerCase();
            Array.from(tbody.children).forEach(tr=>{
              const txt = tr.innerText.toLowerCase();
              tr.style.display = txt.includes(q)? '':'none';
            });
          }})
        ),
        createEl('div', {style:'display:flex;gap:8px;flex-wrap:wrap'},
          createEl('button', {className:'btn small ghost', onclick:()=>{
            const rows = [['الورقة','العمود (حرف)','العمود (رقم)','الخلية (عنوان العنوان)','عنوان العمود','أول صف بيانات','خلية مثال','قيمة المثال','عدد الخلايا غير الفارغة','عمود مهم؟'], ...analysis.summary];
            downloadCSV(`${fileName}__${wsName}__summary.csv`, rows);
          }}, 'تنزيل الملخص CSV'),
          createEl('button', {className:'btn small ghost', onclick:()=>{
            const rows = [['الورقة','الخلية','الصف','العمود (حرف)','العمود (رقم)','القيمة'], ...analysis.cellDump];
            downloadCSV(`${fileName}__${wsName}__cells.csv`, rows);
          }}, 'تفريغ كل الخلايا CSV')
        )
      );

      const table = createEl('table');
      const thead = createEl('thead');
      const tbody = createEl('tbody');

      const headers = ['العمود (حرف)','العمود (رقم)','خلية عنوان العمود','عنوان العمود','أول صف بيانات','خلية مثال','قيمة المثال','عدد غير فارغ','مهم؟'];
      const sorts = new Array(headers.length).fill(null);

      const trh = createEl('tr');
      headers.forEach((h, idx)=>{
        const th = createEl('th', {} , h);
        th.style.cursor='pointer';
        th.title = 'اضغط للفرز';
        th.onclick = () => {
          const asc = sorts[idx]===true? false: true; sorts.fill(null); sorts[idx]=asc;
          // فرز based on the column idx (shift لأن الملخص يحتوي ورقة أولاً)
          const offset = 1; // نعرض من بعد اسم الورقة
          analysis.summary.sort((a,b)=>{
            const va=a[idx+offset], vb=b[idx+offset];
            if(!isNaN(va) && !isNaN(vb)) return asc? (va-vb):(vb-va);
            return asc? String(va).localeCompare(String(vb), 'ar') : String(vb).localeCompare(String(va), 'ar');
          });
          renderBody();
        };
        trh.appendChild(th);
      });
      thead.appendChild(trh);

      function renderBody(){
        tbody.innerHTML='';
        analysis.summary.forEach(row=>{
          const tr = createEl('tr');
          const isKey = row[HDR_IS_KEY]==='نعم';
          [row[HDR_COL_LETTER], row[HDR_COL_NUM], row[HDR_HDR_CELL], row[HDR_TITLE], row[HDR_FIRST_DATA], row[HDR_EXAMPLE_CELL], row[HDR_EXAMPLE_VAL], row[HDR_NONEMPTY], row[HDR_IS_KEY]].forEach((cell, i)=>{
            const td = createEl('td', {}, (cell==null ? '' : String(cell)));
            if(i===8 && isKey) td.classList.add('key');
            if(i===3 && String(cell).trim()==='') td.classList.add('muted');
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      }
      renderBody();

      table.appendChild(thead); table.appendChild(tbody);

      section.appendChild(head);
      section.appendChild(filterBox);
      section.appendChild(table);
      container.appendChild(section);
    }

    async function analyzeFile(file, maxScanRows, keyWords){
      const ab = await file.arrayBuffer();
      const wb = XLSX.read(ab, {type:'array'});
      const results = {};
      for(const wsName of wb.SheetNames){
        const sheet = wb.Sheets[wsName];
        const analysis = analyzeSheet(wsName, sheet, keyWords, maxScanRows);
        results[wsName]=analysis;
      }
      return results;
    }

    function renderFile(resultsWrap, fileName, fileResults){
      const card = createEl('div', {className:'file-card'});
      const head = createEl('div', {className:'file-head'},
        createEl('div', {className:'file-title'}, fileName),
        createEl('div', {className:'file-tools'},
          createEl('span', {className:'badge'}, `${Object.keys(fileResults).length} ورقة`),
          createEl('button', {className:'btn small ghost', onclick:()=>{
            // CSV لجميع الأوراق (ملخص)
            const rows = [['الورقة','العمود (حرف)','العمود (رقم)','الخلية (عنوان العنوان)','عنوان العمود','أول صف بيانات','خلية مثال','قيمة المثال','عدد الخلايا غير الفارغة','عمود مهم؟']];
            for(const wsName in fileResults){
              rows.push(...fileResults[wsName].summary);
            }
            downloadCSV(`${fileName}__SUMMARY_ALL_SHEETS.csv`, rows);
          }}, 'تنزيل ملخص كل الأوراق')
        )
      );

      card.appendChild(head);

      const sheetsWrap = createEl('div', {style:'padding:8px 0'});
      card.appendChild(sheetsWrap);

      for(const wsName in fileResults){
        renderSheet(sheetsWrap, fileName.replace(/\.[^.]+$/, ''), wsName, fileResults[wsName]);
      }

      resultsWrap.appendChild(card);
    }

    // ===== ربط الواجهة =====
    const fileInput = byId('fileInput');
    const analyzeBtn = byId('analyzeBtn');
    const clearBtn = byId('clearBtn');
    const results = byId('results');
    const hdrCount = byId('hdrCount');
    const hdrCountLabel = byId('hdrCountLabel');
    const howMany = byId('howMany');
    const keyWords = byId('keyWords');

    hdrCount.addEventListener('input', ()=>{
      hdrCountLabel.textContent = hdrCount.value;
      howMany.textContent = hdrCount.value;
    });

    clearBtn.addEventListener('click', ()=>{ results.innerHTML=''; });

    analyzeBtn.addEventListener('click', async ()=>{
      const files = Array.from(fileInput.files||[]);
      if(files.length===0){ alert('الرجاء اختيار ملف/ملفات Excel أولاً.'); return; }
      results.innerHTML = '';
      const maxScan = parseInt(hdrCount.value, 10) || 12;
      const kw = keyWords.value || '';

      for(const f of files){
        try{
          const r = await analyzeFile(f, maxScan, kw);
          renderFile(results, f.name, r);
        }catch(err){
          console.error(err);
          const errCard = createEl('div', {className:'card', style:'border-left:3px solid var(--danger)'} , `حدث خطأ أثناء تحليل ${f.name}: `, createEl('span', {className:'danger'}, err.message||String(err)));
          results.appendChild(errCard);
        }
      }
    });
  </script>
</body>
</html>
